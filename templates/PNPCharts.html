<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PNP Charts</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/charts.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
    <header>
        <h1>PNP Charts</h1>
        <p id="datetime">{{ current_datetime }}</p>
    </header>
    <div class="sidebar" id="sidebar">
        <nav>
            <ul>
                <li><a href="{{ url_for('pnp_dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('pnp_charts') }}">Charts</a></li>
            </ul>
        </nav>
    </div>
    <main class="main-content" id="mainContent">
        <div class="tabs">
            <button class="tab active" onclick="filterData('today')">Today</button>
            <button class="tab" onclick="filterData('daily')">Daily</button>
            <button class="tab" onclick="filterData('weekly')">Weekly</button>
            <button class="tab" onclick="filterData('monthly')">Monthly</button>
            <button class="tab" onclick="filterData('yearly')">Yearly</button>
        </div>
        <div class="tabs" style="overflow-x: auto; white-space: nowrap;">
            {% for barangay in barangays %}
            <button class="tab" onclick="filterBarangay('{{ barangay }}')">{{ barangay }}</button>
            {% endfor %}
        </div>
        <div id="chartSection" class="section">
            <div class="chart-container"><h2>Road Accident Cause Chart</h2><canvas id="causeChart"></canvas></div>
            <div class="chart-container"><h2>Road Accident Type Chart</h2><canvas id="typeChart"></canvas></div>
            <div class="chart-container"><h2>Driver Gender Chart</h2><canvas id="genderChart"></canvas></div>
            <div class="chart-container"><h2>Vehicle Type Chart</h2><canvas id="vehicleChart"></canvas></div>
            <div class="chart-container"><h2>Driver Age Chart</h2><canvas id="ageChart"></canvas></div>
            <div class="chart-container"><h2>Road Condition Chart</h2><canvas id="conditionChart"></canvas></div>
        </div>
    </main>
    <script>
        const socket = io.connect('https://alertnow-t1kg.onrender.com' + document.domain + ':' + location.port);
        let charts = {};
        const ctxs = {};
        const barangays = [
            'I-A (Sambat)', 'I-B (City Sub Riverside)', 'I-C (Bagong Bayan)', 'II-A (Triangulo/ Guadalupe 2)', 'II-B (Guadalupe 1)',
            'II-C (Unson)', 'II-D (Bulante)', 'II-E (San Anton)', 'II-F (Villa Rey)', 'III-A (Hermanos Belen)', 'III-B',
            'III-C (Labak/De Roma)', 'III-D (Villongco)', 'III-E', 'III-F (Balagtas)', 'IV-A', 'IV-B', 'IV-C', 'V-A', 'V-B',
            'V-C', 'V-D', 'VI-A (Mavenida)', 'VI-B (Sabang Mabini)', 'VI-C (Bagong Pook)', 'VI-D (Lakeside)', 'VI-E (YMCA)',
            'VII-A (P.Alcantara)', 'VII-B', 'VII-C', 'VII-D', 'VII-E', 'Atisan', 'Bautista', 'Concepcion (Bunot)',
            'Del Remedio (Wawa)', 'Dolores', 'San Antonio 1 (Balanga)', 'San Antonio 2 (Sapa)', 'San Bartolome (Matang-ag)',
            'San Buenaventura (Palakpakin)', 'San Crispin (Lumbangan)', 'San Cristobal', 'San Diego (Tiim)',
            'San Francisco (Calihan)', 'San Gabriel (Butucan)', 'San Gregorio', 'San Ignacio', 'San Isidro (Balagbag)',
            'San Joaquin', 'San Jose (Malamig)', 'San Juan (Putol)', 'San Lorenzo (Saluyan)', 'San Lucas 1 (Malinaw)',
            'San Lucas 2 (Malinaw)', 'San Marcos (Tikew)', 'San Mateo (Imok)', 'San Miguel (Balatuin)',
            'San Nicolas (Mag-ampon)', 'San Pedro', 'San Rafael (Buluburan)', 'San Roque (Sambat)', 'San Vicente',
            'Santa Ana', 'Santa Catalina (Sandig)', 'Santa Cruz (Putol)', 'Santa Elena', 'Santa Filomena (Banlagin)',
            'Santa Isabel', 'Santa Maria', 'Santa Maria Magdalena (Boe / Kuba)', 'Santa Monica', 'Santa Veronica (Bae)',
            'Santiago I (Bulaho)', 'Santiago II (Bulaho)', 'Santisimo Rosario (Balagbag)', 'Santo Angel (Ilog)',
            'Santo Cristo', 'Santo Niño (Arsum)', 'Soledad (Macopa)'
        ];

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('shifted');
        }

        function initCharts(data) {
            ctxs.causeChart = document.getElementById('causeChart').getContext('2d');
            ctxs.typeChart = document.getElementById('typeChart').getContext('2d');
            ctxs.genderChart = document.getElementById('genderChart').getContext('2d');
            ctxs.vehicleChart = document.getElementById('vehicleChart').getContext('2d');
            ctxs.ageChart = document.getElementById('ageChart').getContext('2d');
            ctxs.conditionChart = document.getElementById('conditionChart').getContext('2d');

            charts.causeChart = new Chart(ctxs.causeChart, { type: 'bar', data: data.cause, options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } } } });
            charts.typeChart = new Chart(ctxs.typeChart, { type: 'pie', data: data.type, options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } } } });
            charts.genderChart = new Chart(ctxs.genderChart, { type: 'doughnut', data: data.gender, options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } } } });
            charts.vehicleChart = new Chart(ctxs.vehicleChart, { type: 'bar', data: data.vehicle, options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } } } });
            charts.ageChart = new Chart(ctxs.ageChart, { type: 'line', data: data.age, options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } } } });
            charts.conditionChart = new Chart(ctxs.conditionChart, { type: 'polarArea', data: data.condition, options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } } } });
        }

        function updateCharts(data) {
            charts.causeChart.data = data.cause;
            charts.typeChart.data = data.type;
            charts.genderChart.data = data.gender;
            charts.vehicleChart.data = data.vehicle;
            charts.ageChart.data = data.age;
            charts.conditionChart.data = data.condition;
            Object.values(charts).forEach(chart => chart.update());
        }

        socket.on('pnp_response_update', (data) => {
            if (document.querySelector('.tab.active').textContent.toLowerCase() === 'today' && document.querySelector('.tabs button.active')?.textContent === data.barangay) {
                updateCharts(data);
            }
        });

        function filterData(timeFilter) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[onclick="filterData('${timeFilter}')"]`).classList.add('active');
            const activeBarangay = document.querySelector('.tabs button.active')?.textContent || barangays[0];
            fetch(`/pnp_charts_data?time_filter=${timeFilter}&barangay=${encodeURIComponent(activeBarangay)}`)
                .then(response => response.json())
                .then(data => {
                    if (charts.causeChart) Object.values(charts).forEach(chart => chart.destroy());
                    initCharts(data);
                });
        }

        function filterBarangay(barangay) {
            document.querySelectorAll('.tabs button').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[onclick="filterBarangay('${barangay}')"]`).classList.add('active');
            const activeTimeFilter = document.querySelector('.tab.active')?.textContent.toLowerCase() || 'today';
            fetch(`/pnp_charts_data?time_filter=${activeTimeFilter}&barangay=${encodeURIComponent(barangay)}`)
                .then(response => response.json())
                .then(data => {
                    if (charts.causeChart) Object.values(charts).forEach(chart => chart.destroy());
                    initCharts(data);
                });
        }

        window.onload = () => {
            filterData('today');
            document.querySelector('.tabs button').classList.add('active');
        };
    </script>
</body>
</html>