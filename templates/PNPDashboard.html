<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNP Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='logo/alertnow.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboards.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet-heatmap@1.0.0/dist/leaflet-heatmap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <style>
        .alert-item { 
            font-size: 18px; margin-bottom: 6px; padding: 15px; border-radius: 10px; 
            color: #000000; background-color: #ffffff; border: 1px solid #000000; 
            width: 360px; border-left: 4px solid #e74c3c; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification { position: fixed; bottom: 10px; right: 10px; }
        .response-form { margin-top: 10px; }
        .response-form select, .response-form button { margin: 5px; padding: 5px; border-radius: 4px; }
        .clickable-img { cursor: pointer; max-width: 100%; height: auto; border-radius: 5px; }
        .prediction { margin-top: 10px; font-weight: bold; color: #000; display: none; }

        .alert-grid {
            display: grid;
            grid-template-columns: repeat(5, 360px);
            grid-auto-rows: minmax(280px, auto);
            gap: 30px;
            padding: 20px;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            width: 110%;
            max-width: 150vw;
        }
        .alert-grid::-webkit-scrollbar { height: 10px; }
        .alert-grid::-webkit-scrollbar-track { background: transparent; }
        .alert-grid::-webkit-scrollbar-thumb { background: #e74c3c; border-radius: 10px; }

        #live-alert-container, #recent-alert-container {
            min-height: 680px;
            border-radius: 15px;
            padding: 15px;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 5px; }
        .image-modal .close-btn {
            position: absolute;
            top: 20px; right: 20px;
            color: #fff; font-size: 30px; cursor: pointer;
        }

        .alert-status {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .status-pending { color: #e74c3c; }
        .status-responded { color: #27ae60; }
        .status-expired { color: #27ae60; }

        .alert-tabs {
            display: flex;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .alert-tab {
            padding: 14px 32px;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            transition: all 0.3s;
        }
        .alert-tab:hover { background: #f0f0f0; }
        .alert-tab.active { background: #e74c3c; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .date-filter-container {
            margin: 15px 0;
            text-align: right;
        }
        .date-filter-container input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <nav>
            <ul>
                <img src="{{ url_for('static', filename='logo/alertlogo.png') }}" alt="Alert Logo" class="alert-logo">
                <li><a href="{{ url_for('pnp_dashboard') }}"><span>üè†</span> Dashboard</a></li>
                <li><a href="#alerts"><span>üîî</span> Alerts</a></li>
                <li><a href="#map"><span>üìç</span> Map</a></li>
                <li><a href="{{ url_for('pnp_charts') }}"><span>üìä</span> Manage Reports</a></li>
                <li><a href="#notifications"><span>üì£</span> Notifications</a></li>
                <li><a href="#settings"><span>‚öôÔ∏è</span> Settings</a></li>
                <li><a href="{{ url_for('logout') }}"><span>üö™</span> Log Out</a></li>
            </ul>
        </nav>
    </div>
    <div class="dashboard">
        <header>
            <div class="header-content">
            <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h1>PNP {{ municipality }} Dashboard</h1>
            </div>
            <div class="filters"></div>
        </header>
    </div>

    <main class="main-content" id="mainContent">
        <h2 class="h2" style="position: relative; display: inline-block; margin: 0 auto;">PNP {{ municipality }} Map </h2>
        <p class="p" style="position: relative; display: inline-block; margin: 0 auto;">
            Coordinates: <span id="map-coordinates">{{ lat_coord|default(14.0549) }}, {{ lon_coord|default(121.3013) }}</span>
        </p>

        <div class="dashboard-container">
            <div id="map"></div>
            <section class="stats">
                <div class="stats-row">
                    <div class="stat-item">
                        <p class="p" style="position: relative; display: inline-block; margin: 0 auto;">
                            Total Incidents: 
                            <span id="total-incidents" class="incident-number">
                                {{ stats.total() if stats else 0 }}
                            </span>
                        </p>
                    </div>
                    <div class="stat-item">
                        <p class="p" style="position: relative; display: inline-block; margin: 0 auto;">
                            Responded: 
                            <span id="responded-count" class="incident-number">
                                {{ responded_count if responded_count else 0 }}
                            </span>
                        </p>
                    </div>
                </div>

                <div class="chart-container">
                    <h4>Alerts Received Per Month</h4>
                    <canvas id="alertsPerMonthChart"></canvas>
                </div>
            </section>
        </div>

        <section id="alerts" class="alerts">
            <h2 class="h2">PNP Alerts</h2>

            <div class="alert-tabs">
                <div class="alert-tab active" data-tab="live">Live Alerts</div>
                <div class="alert-tab" data-tab="recent">Recent Alerts</div>
            </div>

            <div id="live-alerts-tab" class="tab-content active">
                <div id="live-alert-container" class="alert-grid"></div>
            </div>

            <div id="recent-alerts-tab" class="tab-content">
                <div class="date-filter-container">
                    <label for="recent-date-filter">Filter by Date: </label>
                    <input type="date" id="recent-date-filter">
                </div>
                <div id="recent-alert-container" class="alert-grid"></div>
            </div>
        </section>

        <div id="notification"></div>
        <div id="image-modal" class="image-modal">
            <span class="close-btn">&times;</span>
            <img id="modal-image" src="">
        </div>
    </main>

    <script>
        window.activeMarkers = window.activeMarkers || {};

        let menuData = {
            'Road Accident': {
                'Road Accident Cause': ['Head-on Collision', 'Rear-end Collision', 'Side-impact Collision', 'Single Vehicle Accident', 'Pedestrian Accident'],
                'Road Accident Type': ['Overspeeding', 'Distracted Driving', 'Drunk Driving', 'Reckless Driving', 'Fatigue', 'Inexperience', 'Mechanical Failure', 'Poor Maintenance', 'Overloading'],
                'Weather Conditions': ['Sunny', 'Rainy', 'Foggy', 'Cloudy', 'Stormy'],
                'Road Conditions': ['Dry', 'Wet', 'Icy', 'Potholes', 'Gravel'],
                'Vehicle Types': ['Car', 'Motorcycle', 'Truck', 'Bus', 'Bicycle'],
                'Driver Ages': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+'],
                'Driver Gender': ['Male', 'Female']
            },
            'Fire Incident': {
                'Fire Cause': [
                    'Electrical ignition caused by loose connection', 'Electrical ignition caused by overloading',  'Electrical ignition due to pinched wire',
                    'Electrical ignition caused by arcing', 'Overheated industrial machinery', 'Sparks from machinery', 'Overheated home appliances', 'Electrical post fire to structural fire',
                    'Transformer pole fire to structural fire', 'Open flame from cooking (LPG / gas stove, firewood)', 'Open flame from unattended lighted candle',
                    'Open flame from kerosene lamp (gasera) / lighting torch (sulo)', 'Open flame from rubbish fire / bonfire to structural fire',
                    'Open flame from farmland / agricultural land clearing operation', 'Open flame from kaingin (slash and burn)',
                    'Ignition caused by firecracker explosion',
                    'Ignition caused by fireworks / pyrotechnics explosion',
                    'Ignition caused by bomb explosion',
                    'Spontaneous combustion of chemicals',
                    'Spontaneous combustion of solid materials',
                    'Intentional fire by use of incendiary device or mechanism',
                    'Intentional fire by use of flammable liquid',
                    'Intentional fire by use of open flame (matchstick or lighter or light torch)',
                    'Ignition of material caused by welding slags',
                    'Ignition of materials caused by acetylene / other hot works',
                    'LPG explosion caused by defective tank',
                    'LPG explosion caused by defective hose line',
                    'LPG explosion caused by defective regulator',
                    'LPG explosion caused by defective stove',
                    'LPG explosion caused by static electricity or spark',
                    'Fire caused by lightning',
                    'Ignition of materials from ember / flying ember or alipato',
                    'Smoking (lighted cigarette, cigar or pipe)',
                    'Children playing matchstick or lighter',
                    'Battery short circuit or battery explosion',
                    'Dust explosion',
                    'Magnified / amplified sun rays',
                    'Overheated engine (motor vehicles)',
                    'Sky lantern',
                    'Fire incident under investigation (on process)',
                    'Undetermined fire cause (on pending investigation)'
                ],
                'Occupancy Type': [
                    'Assembly', 'Educational', 'Day-Care', 'Health Care',
                    'Detention & Correctional / Institutional', 'Residential',
                    'Mercantile', 'Business', 'Industrial', 'Storage',
                    'Mixed Occupancies', 'Miscellaneous Occupancies'
                ],
                'Class': {
                    'CLASS A': 'Ordinary Combustibles\n(Wood, paper, cloth, plastic, rubber, trash, and other common combustible materials. Extinguishing Method: Water, foam, dry chemical.)',
                    'CLASS B': 'Flammable Liquids & Gases\n(Gasoline, diesel, alcohol, paints, solvents, kerosene, LPG, acetylene, etc. Extinguishing Method: Foam, dry chemical (ABC/BC), CO2. Do NOT use water - it spreads the flammable liquid.)',
                    'CLASS C': 'Energized Electrical Equipment\n(Electrical panels, wirings, appliances, transformers, computers, breakers. Extinguishing Method: Dry chemical, CO2.)',
                    'CLASS D': 'Combustible Metals\n(Magnesium, titanium, sodium, potassium, zirconium, lithium. Extinguishing Method: Special Class D dry powder extinguishers. Do NOT use water - it reacts violently.)',
                    'CLASS K (or Class F)': 'Cooking Oils & Fats\n(Hot oils and fats from deep fryers, lard, shortening, grease.)'
                }
            },
            'Crime Incident': {
                'Crime Types': ['Theft', 'Assault', 'Burglary', 'Robbery', 'Vandalism', 'Harassment', 'Domestic Violence', 'Drug-Related', 'Fraud'],
                'Crime Causes': ['Poverty', 'Unemployment', 'Alcohol', 'Drugs', 'Personal Dispute', 'Gang Activity', 'Opportunistic', 'Domestic Issue', 'Mental Health'],
                'Levels': ['Low', 'Medium', 'High'],
                'Suspect Gender': ['Male', 'Female'],
                'Victim Gender': ['Male', 'Female'],
                'Suspect Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+'],
                'Victim Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+']
            }
        };

        const liveAlerts = new Map();
        const recentAlerts = new Map();
        const alertElements = new Map();

        function moveToRecent(alertId) {
            if (!liveAlerts.has(alertId)) return;
            const { element } = liveAlerts.get(alertId);
            liveAlerts.delete(alertId);
            recentAlerts.set(alertId, { element, timestamp: Date.now() });

            const statusDiv = element.querySelector('.alert-status');
            statusDiv.textContent = 'EXPIRED ALERT';
            statusDiv.className = 'alert-status status-expired';

            document.getElementById('recent-alert-container')
                    .insertBefore(element, document.getElementById('recent-alert-container').firstChild);
        }

        document.querySelectorAll('.alert-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.alert-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-alerts-tab').classList.add('active');
            });
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('shifted');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const lat = {{ lat_coord|default(14.0549) }};
            const lon = {{ lon_coord|default(121.3013) }};
            const mapboxToken = 'pk.eyJ1Ijoia3VtaXRva2lydSIsImEiOiJjbWNvZXpkdDQwNmdvMnNyMnNtNGw5NGI1In0.3Y9z5y4saOL76Eb5c-o0UQ';
            const tileLayerUrl = `https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxToken}`;

            const pnpMap = L.map('map').setView([lat, lon], 16);
            L.tileLayer(tileLayerUrl, { attribution: '¬© Mapbox ¬© OpenStreetMap', maxZoom: 18, tileSize: 512, zoomOffset: -1 }).addTo(pnpMap);

            const socket = io('https://alertnow-wi0n.onrender.com', { transports: ['websocket'] });

            // Chart setup (your full code preserved)
            const ctx = document.getElementById('alertsPerMonthChart');
            if (!ctx) {
                console.error('Canvas element #alertsPerMonthChart not found');
            } else {
                const chartCtx = ctx.getContext('2d');
                if (!chartCtx) {
                    console.error('Failed to get 2D context for #alertsPerMonthChart');
                } else {
                    let alertsPerMonthChart = new Chart(chartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                            datasets: [{
                                label: 'Alerts Per Month',
                                data: [
                                    {{ alerts_per_month['January']|default(0) }},
                                    {{ alerts_per_month['February']|default(0) }},
                                    {{ alerts_per_month['March']|default(0) }},
                                    {{ alerts_per_month['April']|default(0) }},
                                    {{ alerts_per_month['May']|default(0) }},
                                    {{ alerts_per_month['June']|default(0) }},
                                    {{ alerts_per_month['July']|default(0) }},
                                    {{ alerts_per_month['August']|default(0) }},
                                    {{ alerts_per_month['September']|default(0) }},
                                    {{ alerts_per_month['October']|default(0) }},
                                    {{ alerts_per_month['November']|default(0) }},
                                    {{ alerts_per_month['December']|default(0) }}
                                ],
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                                    '#FF6F61', '#6B7280', '#F4A261', '#2A9D8F', '#E76F51', '#D00000'
                                ],
                                borderColor: ['#080808ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff', '#000000ff'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 1.5,
                            plugins: {
                                legend: {
                                    display: false, // Removed vertical legend display
                                    position: 'bottom',
                                    labels: {
                                        color: '#000000',
                                        font: { size: 17 },
                                        generateLabels: function(chart) {
                                            const labels = chart.data.labels;
                                            return labels.map((label, index) => ({
                                                text: label,
                                                fillStyle: chart.data.datasets[0].backgroundColor[index],
                                                strokeStyle: chart.data.datasets[0].borderColor[index],
                                                lineWidth: chart.data.datasets[0].borderWidth,
                                                hidden: false,
                                                index: index,
                                                datasetIndex: 0
                                            }));
                                        },
                                        boxWidth: 20,
                                        padding: 10,
                                        usePointStyle: true
                                    },
                                    onClick: function(e, legendItem, legend) {
                                        const index = legendItem.index;
                                        const ci = legend.chart;
                                        const meta = ci.getDatasetMeta(0);
                                        meta.data[index].hidden = !meta.data[index].hidden;
                                        ci.update();
                                    }
                                },
                                layout: {
                                    padding: {
                                        bottom: 20
                                    }
                                }
                            }
                        }
                    });

                    const twoRowLegendPlugin = {
                        id: 'twoRowLegend',
                        afterUpdate(chart) {
                            const legend = chart.options.plugins.legend;
                            if (legend && legend.position === 'bottom') {
                                const legendElement = document.querySelector(`#${chart.canvas.id}-legend`);
                                if (!legendElement) {
                                    const container = document.createElement('div');
                                    container.id = `${chart.canvas.id}-legend`;
                                    container.className = 'chart-legend-two-rows';
                                    chart.canvas.parentNode.appendChild(container);
                                    
                                    const labels = chart.data.labels;
                                    const firstRow = labels.slice(0, 6); // January to June
                                    const secondRow = labels.slice(6, 12); // July to December
                                    
                                    [firstRow, secondRow].forEach((row, rowIndex) => {
                                        const rowDiv = document.createElement('div');
                                        rowDiv.style.display = 'flex';
                                        rowDiv.style.justifyContent = 'center';
                                        rowDiv.style.marginBottom = rowIndex === 0 ? '10px' : '20px';
                                        rowDiv.style.gap = '15px'; 
                                        
                                        row.forEach((label, index) => {
                                            const actualIndex = rowIndex * 6 + index;
                                            const item = document.createElement('div');
                                            item.className = 'chart-legend-item';
                                            item.innerHTML = `
                                                <span style="display: inline-block; width: 20px; height: 20px; background-color: ${chart.data.datasets[0].backgroundColor[actualIndex]}; margin-right: 5px; vertical-align: middle;"></span>
                                                <span style="color: #000000; font-size: 17px;">${label}</span>
                                            `;
                                            item.onclick = () => {
                                                const meta = chart.getDatasetMeta(0);
                                                meta.data[actualIndex].hidden = !meta.data[actualIndex].hidden;
                                                chart.update();
                                            };
                                            rowDiv.appendChild(item);
                                        });
                                        
                                        container.appendChild(rowDiv);
                                    });
                                }
                            }
                        }
                    };

                    Chart.register(twoRowLegendPlugin);

                    // Fallback if data is empty
                    if (alertsPerMonthChart.data.datasets[0].data.every(value => value === 0)) {
                        console.warn('Chart initialized with zero data. Check database or server logs.');
                    }

                    socket.on('update_alerts_per_month', (data) => {
                        console.log('Received update_alerts_per_month:', data);
                        alertsPerMonthChart.data.datasets[0].data = [
                            data['January'] || 0,
                            data['February'] || 0,
                            data['March'] || 0,
                            data['April'] || 0,
                            data['May'] || 0,
                            data['June'] || 0,
                            data['July'] || 0,
                            data['August'] || 0,
                            data['September'] || 0,
                            data['October'] || 0,
                            data['November'] || 0,
                            data['December'] || 0
                        ];
                        alertsPerMonthChart.update();
                    });
                }
            }

            socket.on('connect', () => {
                socket.emit('register_role', { role: 'pnp', municipality: '{{ municipality }}'.toLowerCase() });
            });

            socket.on('pnp_redirect_alert', (data) => {
                console.log('PNP redirect alert received:', data);
                updateUIWithAlert(data);
                notifyAlert(data);
            });

            socket.on('redirected_alert', (data) => {
                if (data.target_role === 'pnp') {
                    console.log('Direct PNP alert received:', data);
                    updateUIWithAlert(data);
                    notifyAlert(data);
                }
            });

            socket.on('update_map', (data) => {
                const lat = data.lat || {{ lat_coord|default(14.0549) }};
                const lon = data.lon || {{ lon_coord|default(121.3013) }};

                if (window.activeMarkers[data.alert_id]) {
                    pnpMap.removeLayer(window.activeMarkers[data.alert_id]);
                }
                const marker = L.marker([lat, lon]).addTo(pnpMap)
                    .bindPopup(`${data.emergency_type} at ${data.barangay}`)
                    .openPopup();
                window.activeMarkers[data.alert_id] = marker;
                pnpMap.setView([lat, lon], 15);
                document.getElementById('map-coordinates').textContent = `${lat}, ${lon}`;
            });

            function updateUIWithAlert(data) {
                const container = document.getElementById('live-alert-container');
                const alertItem = document.createElement('div');
                alertItem.className = 'alert-item';
                alertItem.dataset.alertId = data.alert_id;

                alertItem.innerHTML = `
                    <div class="alert-status status-pending">PENDING ${data.emergency_type?.toUpperCase() || 'ALERT'}</div>
                    <div><strong>From:</strong> ${data.barangay}</div>
                    <div><strong>Resident:</strong> ${data.resident_barangay || data.barangay}</div>
                    <div><strong>Time:</strong> ${new Date().toLocaleTimeString()}</div>
                    ${data.image ? `<img src="data:image/jpeg;base64,${data.image}" class="clickable-img" />` : ''}
                    <div class="response-form"></div>
                    <div class="prediction" style="display:none;">Prediction: Calculating...</div>
                `;

                if (data.image) {
                    alertItem.querySelector('img').onclick = () => {
                        document.getElementById('modal-image').src = `data:image/jpeg;base64,${data.image}`;
                        document.getElementById('image-modal').style.display = 'flex';
                    };
                }

                const responseForm = alertItem.querySelector('.response-form');
                responseForm.style.display = 'block';

                const emergencyType = data.emergency_type || 'Unknown';
                const dropdownData = menuData[emergencyType] || {};

                Object.keys(dropdownData).forEach(key => {
                    const select = document.createElement('select');
                    select.className = 'dropdown-emergency';
                    select.name = key.toLowerCase().replace(/\s+/g, '_');

                    const placeholder = document.createElement('option');
                    placeholder.text = `Select ${key}`;
                    placeholder.value = '';
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    select.appendChild(placeholder);

                    let options = dropdownData[key];
                    if (typeof options === 'object' && !Array.isArray(options)) {
                        options = Object.keys(options);
                    }

                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = typeof opt === 'string' && opt.includes('\n') ? opt.split('\n')[0] : opt;
                        select.appendChild(option);
                    });
                    responseForm.appendChild(select);
                });

                const submitBtn = document.createElement('button');
                submitBtn.textContent = 'Submit Response';
                submitBtn.className = 'submit-emergency';
                submitBtn.onclick = () => {
                    const formData = {
                        alert_id: data.alert_id,
                        emergency_type: emergencyType,
                        municipality: '{{ municipality }}'.toLowerCase(),
                        barangay: data.barangay,
                        lat: data.lat,
                        lon: data.lon
                    };

                    responseForm.querySelectorAll('select').forEach(s => {
                        formData[s.name] = s.value;
                    });

                    if (emergencyType === 'Road Accident') {
                        socket.emit('pnp_response', formData);
                    } else if (emergencyType === 'Fire Incident') {
                        socket.emit('pnp_fire_submitted', formData);
                    } else if (emergencyType === 'Crime Incident') {
                        socket.emit('pnp_crime_submitted', formData);
                    }

                    const statusDiv = alertItem.querySelector('.alert-status');
                    statusDiv.textContent = 'RESPONDED';
                    statusDiv.className = 'alert-status status-responded';
                    responseForm.style.display = 'none';

                    const predictionDiv = alertItem.querySelector('.prediction');
                    predictionDiv.style.display = 'block';
                    predictionDiv.innerHTML = '<em>Calculating prediction...</em>';

                    liveAlerts.set(data.alert_id, { element: alertItem });
                    setTimeout(() => moveToRecent(data.alert_id), 60000);
                };
                responseForm.appendChild(submitBtn);

                container.appendChild(alertItem);
                alertElements.set(data.alert_id, alertItem);
            }

            // YOUR 3 PREDICTION BLOCKS ‚Äî 100% PRESERVED EXACTLY AS YOU WROTE
            socket.on('pnp_response', (data) => {
                console.log('PNP response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again Within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '16px';
                    predictionDiv.style.color = 'black';
                }
            });

            socket.on('pnp_fire_submitted', (data) => {
                console.log('PNP fire response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again Within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '16px';
                    predictionDiv.style.color = 'black';
                }
            });

            socket.on('pnp_crime_submitted', (data) => {
                console.log('PNP crime response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again Within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '16px';
                    predictionDiv.style.color = 'black';
                }
            });


            function notifyAlert(data) {
                const n = document.getElementById('notification');
                n.textContent = `New ${data.emergency_type} Alert at ${data.barangay || 'Unknown'}`;
                setTimeout(() => n.textContent = '', 6000);
            }

            document.getElementById('image-modal').querySelector('.close-btn').onclick = () => {
                document.getElementById('image-modal').style.display = 'none';
            };

            document.getElementById('recent-date-filter').addEventListener('change', (e) => {
                const val = e.target.value;
                document.querySelectorAll('#recent-alert-container .alert-item').forEach(item => {
                    const timeText = item.querySelector('div:nth-child(4)').textContent;
                    item.style.display = (!val || timeText.includes(val)) ? 'block' : 'none';
                });
            });
        });
    </script>
</body>
</html>