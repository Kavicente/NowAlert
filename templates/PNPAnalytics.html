<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PNP Analytics - {{ municipality }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        .week-selector, .date-selector { margin: 10px 0; }
        .week-selector button, .date-selector button { padding: 5px 10px; margin: 5px; }
        .week-selector button.active, .date-selector button.active { background-color: #36A2EB; color: white; }
        .summary-container { float: right; width: 300px; padding: 10px; border: 1px solid #ccc; margin: 10px; }
    </style>
</head>
<body>
    <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
    <header class="h1">PNP {{ municipality }} Reports</header>
    <p id="datetime">{{ current_datetime }}</p>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <nav>
            <ul>
                <li><a href="{{ url_for('pnp_dashboard') }}">Dashboard</a></li>
                <li><a href="#" onclick="showSection('road')">Road Accident Reports</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <div class="tabs">
            <button class="tab active" onclick="filterData('today')">Today</button>
            <button class="tab" onclick="filterDaily()">Daily</button>
            <button class="tab" onclick="filterWeekly()">Weekly</button>
            <button class="tab" onclick="filterData('monthly')">Monthly</button>
            <button class="tab" onclick="filterData('yearly')">Yearly</button>
        </div>

        <!-- Daily Selector -->
        <div class="date-selector" id="dailySelector" style="display: none;">
            <p>Yesterday: <span id="yesterdayDate"></span></p>
        </div>

        <!-- Weekly Selector -->
        <div class="week-selector" id="weekSelector" style="display: none;">
            <p>Select Week:</p>
            <div id="weekButtons"></div>
            <div id="dateButtons" style="display: none;"></div>
            <div class="summary-container" id="weeklySummary"></div>
        </div>

        <!-- Road Accident Section -->
        <header class="header2" id="letterR" class="section">Road Accident Reports</header>
        <div id="roadSection" class="section">
            <div class="chart-container"><h2>Incident Trends</h2><canvas id="crimeIncidentTrendsChart"></canvas></div>
            <div class="chart-container"><h2>Incident Distribution</h2><canvas id="crimeIncidentDistributionChart"></canvas></div>
            <div class="chart-container"><h2>Responded Alerts</h2><canvas id="crimeRespondedAlertsChart"></canvas></div>
            <div class="chart-container"><h2>Crime Type Analysis</h2><canvas id="crimeTypeAnalysisChart"></canvas></div>
            <div class="chart-container"><h2>Road Condition</h2><canvas id="roadConditionChart"></canvas></div>
            <div class="chart-container"><h2>Weather Condition</h2><canvas id="roadWeatherChart"></canvas></div>
            <div class="chart-container"><h2>Vehicle Types</h2><canvas id="roadVehicleTypesChart"></canvas></div>
            <div class="chart-container"><h2>Driver's Age</h2><canvas id="roadDriverAgeChart"></canvas></div>
            <div class="chart-container"><h2>Driver's Gender</h2><canvas id="roadDriverGenderChart"></canvas></div>
        </div>
    </main>

    <script>
        let charts = {};
        const socket = io('https://alert-858l.onrender.com');

        socket.on('connect', () => {
            socket.emit('register_role', {
                role: 'pnp',
                municipality: '{{ municipality | lower }}'
            });
        });

        socket.on('update_response', (data) => {
            if (document.querySelector('.tab.active').textContent.toLowerCase() === 'today') {
                filterData('today');
            }
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('shifted');
        }

        function showSection(type) {
            const roadHeader = document.getElementById('letterR');
            const roadSection = document.getElementById('roadSection');

            if (type === 'road') {
                roadHeader.classList.remove('hidden');
                roadSection.classList.remove('hidden');
            }

            filterData(document.querySelector('.tab.active').textContent.toLowerCase());
        }

        function setActiveTab(tabElement) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
        }

        function filterData(timePeriod) {
            setActiveTab(document.querySelector(`button[onclick="filterData('${timePeriod}')"]`) || document.querySelector('.tab'));
            document.getElementById('dailySelector').style.display = timePeriod === 'daily' ? 'block' : 'none';
            document.getElementById('weekSelector').style.display = timePeriod === 'weekly' ? 'block' : 'none';
            fetch(`/api/pnp_analytics_data?time=${timePeriod}&municipality={{ municipality | lower }}`)
                .then(response => response.json())
                .then(data => updateCharts(data))
                .catch(error => console.error('Error fetching data:', error));
        }

        function filterDaily() {
            setActiveTab(document.querySelector('button[onclick="filterDaily()"]'));
            document.getElementById('dailySelector').style.display = 'block';
            document.getElementById('weekSelector').style.display = 'none';
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('yesterdayDate').textContent = yesterday.toISOString().split('T')[0];
            fetch(`/api/pnp_analytics_data?time=daily&municipality={{ municipality | lower }}&date=${yesterday.toISOString().split('T')[0]}`)
                .then(response => response.json())
                .then(data => updateCharts(data))
                .catch(error => console.error('Error fetching daily data:', error));
        }

        function filterWeekly() {
            setActiveTab(document.querySelector('button[onclick="filterWeekly()"]'));
            document.getElementById('dailySelector').style.display = 'none';
            document.getElementById('weekSelector').style.display = 'block';
            // Week selection logic remains unchanged
        }

        function updateCharts(data) {
            const role = 'pnp';
            if (charts) {
                Object.values(charts).forEach(chart => chart.destroy());
            }
            charts = {};

            // Ensure data fields exist, provide defaults if missing
            const defaultData = {
                trends: { labels: [], total: [], responded: [] },
                distribution: {},
                causes: { road: {}, fire: {} },
                types: {},
                road_conditions: {},
                weather: {},
                vehicle_types: {},
                driver_age: {},
                driver_gender: {}
            };
            data = { ...defaultData, ...data };

            if (role === 'pnp') {
                renderLine('crimeIncidentTrendsChart', data.trends.labels, [
                    { label: 'Total Incidents', data: data.trends.total, borderColor: '#36A2EB', backgroundColor: 'rgba(54, 162, 235, 0.2)' },
                    { label: 'Responded Incidents', data: data.trends.responded, borderColor: '#FF6384', backgroundColor: 'rgba(255, 99, 132, 0.2)' }
                ], 'Incident Trends');
                renderPie('crimeIncidentDistributionChart', Object.keys(data.distribution).reduce((acc, k) => ({ ...acc, [k]: data.distribution[k].total }), {}), 'Incident Distribution');
                renderBar('crimeRespondedAlertsChart', Object.keys(data.distribution), Object.values(data.distribution).map(d => d.responded || 0), 'Responded Alerts');
                renderBar('crimeTypeAnalysisChart', data.causes.road, 'Crime Type Analysis');
                renderPie('roadConditionChart', data.road_conditions, 'Road Condition');
                renderPie('roadWeatherChart', data.weather, 'Weather Condition');
                renderPie('roadVehicleTypesChart', data.vehicle_types, 'Vehicle Types');
                renderBar('roadDriverAgeChart', data.driver_age, 'Driver\'s Age');
                renderPie('roadDriverGenderChart', data.driver_gender, 'Driver\'s Gender');
            }
        }

        function renderPie(canvasId, objData, title) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (charts[canvasId]) charts[canvasId].destroy();
            charts[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(objData),
                    datasets: [{ data: Object.values(objData), backgroundColor: generateColors(objData) }]
                },
                options: { 
                    responsive: true, 
                    plugins: { 
                        title: { display: true, text: title },
                        legend: { position: 'top' }
                    }
                }
            });
        }

        function renderLine(canvasId, labels, datasets, title) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (charts[canvasId]) charts[canvasId].destroy();
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: datasets.map(ds => ({
                        label: ds.label,
                        data: ds.data,
                        borderColor: ds.borderColor,
                        backgroundColor: ds.backgroundColor,
                        fill: true
                    }))
                },
                options: { 
                    responsive: true,
                    plugins: { 
                        title: { display: true, text: title }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderBar(canvasId, objDataOrLabels, data, title) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            let labels = Array.isArray(objDataOrLabels) ? objDataOrLabels : Object.keys(objDataOrLabels);
            let dataset = Array.isArray(data) ? data : Object.values(objDataOrLabels);
            if (charts[canvasId]) charts[canvasId].destroy();
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: title, 
                        data: dataset, 
                        backgroundColor: '#36A2EB',
                        borderColor: '#36A2EB',
                        borderWidth: 1
                    }] 
                },
                options: { 
                    responsive: true,
                    plugins: { 
                        title: { display: true, text: title }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function generateColors(obj) {
            const palette = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8A2BE2', '#00CED1', '#FF4500', '#2E8B57'];
            return Object.keys(obj).map((_, i) => palette[i % palette.length]);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const defaultTab = document.querySelector('.tab');
            if (defaultTab) {
                defaultTab.classList.add('active');
                filterData('today');
            }
        });
    </script>
</body>
</html>