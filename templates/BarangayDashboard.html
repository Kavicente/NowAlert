<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='logo/alertnow.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet-heatmap@1.0.0/dist/leaflet-heatmap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/test_socket.js') }}"></script>
    <style>
        .alert-item { 
            font-size: 18px; 
            margin-bottom: 6px; 
            padding: 15px; 
            border-radius: 10px; 
            color: #000000; 
            background-color: #ffffff; 
            border: 1px solid #000000; 
            width: 360px;  
            border-left: 4px solid #3498db;
        }
        .alert-grid {
            display: grid;
            grid-template-columns: repeat(5, 360px);    /* Exactly 5 cards per row */
            grid-auto-rows: minmax(280px, auto);
            gap: 30px;
            padding: 20px;
            overflow-x: auto;         
            margin-right: -250px;                  /* Horizontal scroll */
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            width: 110%;
            max-width: 150vw;
        }

        .alert-grid::-webkit-scrollbar {
            height: 10px;
            display: none;  
        }
        .alert-grid::-webkit-scrollbar-track {
            
            display: none;  
        }
        .alert-grid::-webkit-scrollbar-thumb {
            display: none;  
        }

        .alert-item {
            scroll-snap-align: start;
            min-width: 360px;
            max-width: 360px;
            height: fit-content;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification { 
            position: fixed; 
            width: 50px; 
            bottom: 10px; 
            right: 10px; 
        }
        .response-form { 
            margin-top: 10px; 
            display: none; 
        }
        .response-form select, 
        .response-form button { 
            margin: 5px; 
            padding: 5px; 
            border-radius: 4px; 
        }
        .clickable-img { 
            cursor: pointer; 
            max-width: 100%; 
            height: auto; 
            border-radius: 5px; 
        }
        .prediction { 
            margin-top: 10px; 
            font-weight: bold; 
            color: #000; 
            display: none; 
        }
        
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 5px;
        }
        .image-modal .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
        }

        /* Tabs Styling */
        .alert-tabs {
            display: flex;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .alert-tab {
            padding: 14px 32px;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            transition: all 0.3s;
        }
        .alert-tab:hover {
            background: #f0f0f0;
        }
        .alert-tab.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .date-filter-container {
            margin: 15px 0;
            text-align: right;
        }
        .date-filter-container input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        #live-alert-container,
        #recent-alert-container {
            min-height: 320px;
            padding-bottom: 20px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255,0,0,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
        }
        .prediction-charts-container {
            display: flex; /* Show by default */
            gap: 30px;
            margin-top: 40px;
            width: 100%;
        }
        .prediction-chart-wrapper {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            height: 450px; /* Give a fixed height */
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <nav>
            <ul>
                <img src="{{ url_for('static', filename='logo/alertlogo.png') }}" alt="Alert Logo" class="alert-logo">
                <li><a href="{{ url_for('barangay_dashboard') }}"><span>üè†</span> Dashboard</a></li>
                <li><a href="#alerts"><span>üîî</span> Alerts</a></li>
                <li><a href="#map"><span>üìç</span> Map</a></li>
                <li><a href="{{ url_for('barangay_charts') }}"><span>üìä</span> Manage Reports</a></li>
                <li><a href="#notifications"><span>üì£</span> Notifications</a></li>
                <li><a href="#settings"><span>‚öôÔ∏è</span> Settings</a></li>
                <li><a href="{{ url_for('logout') }}"><span>üö™</span> Log Out</a></li>

            </ul>
        </nav>
    </div>
    
    <div class="dashboard">
        <header>
            <div class="header-content">
                <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h1>Barangay {{ barangay }} Dashboard</h1>
            </div>
            <div class="filters"></div>
        </header>
    </div>

    <main class="main-content" id="mainContent">
        <h2 class="h2" style="position: relative; display: inline-block; margin: 0 auto;">Barangay {{ barangay }} Map </h2>
        <p class="p" style="position: relative; display: inline-block; margin: 0 auto;">
            Coordinates: <span id="map-coordinates">{{ lat_coord|default(14.0549) }}, {{ lon_coord|default(121.3013) }}</span> (Barangay: {{ barangay }})
        </p>

        <div class="dashboard-container">
            <div id="map"></div>
            <section class="stats">
                <div class="stats-row">
                    <div class="stat-item">
                        <p class="p" style="position: relative; display: inline-block; margin: 0 auto;">
                            Total Incidents: 
                            <span id="total-incidents" class="incident-number">
                                {{ stats.total() if stats else 0 }}
                            </span>
                        </p>
                    </div>
                    <div class="stat-item">
                        <p class="p" style="position: relative; display: inline-block; margin: 0 auto;">
                            Responded: 
                            <span id="responded-count" class="incident-number">
                                {{ responded_count if responded_count else 0 }}
                            </span>
                        </p>
                    </div>
                </div>
                <div class="chart-container">
                    <h4>Emergency Types</h4>
                    <canvas id="emergencyTypeChart"></canvas>
                </div>
            </section>
        </div>

        <!-- ALERTS SECTION WITH TABS -->
        <section id="alerts" class="alerts">
            <h2 class="h2">Live Alerts</h2>

            <div class="alert-tabs">
                <div class="alert-tab active" data-tab="live">Live Alerts</div>
                <div class="alert-tab" data-tab="recent">Recent Alerts</div>
            </div>

            <!-- Live Alerts -->
            <div id="live-alerts-tab" class="tab-content active">
                <div id="live-alert-container" class="alert-grid"></div>
            </div>

            <!-- Recent Alerts -->
            <div id="recent-alerts-tab" class="tab-content">
                <div class="date-filter-container">
                    <label for="recent-date-filter">Filter by Date: </label>
                    <input type="date" id="recent-date-filter">
                </div>
                <div id="recent-alert-container" class="alert-grid"></div>
            </div>
        </section>

        <!-- Prediction Charts Section -->
        <section class="prediction-charts-container">
            <div class="prediction-chart-wrapper">
                <canvas id="yearlyPredictionChart"></canvas>
            </div>
            <div class="prediction-chart-wrapper">
                <canvas id="monthlyPredictionChart"></canvas>
            </div>
        </section>

        <div id="notification"></div>
        <div id="image-modal" class="image-modal">
            <span class="close-btn">&times;</span>
            <img id="modal-image" src="">
        </div>
    </main>

    <script>
        let menuData = {
            'Road Accident': {
                'Road Accident Cause': ['Head-on Collision', 'Rear-end Collision', 'Side-impact Collision', 'Single Vehicle Accident', 'Pedestrian Accident'],
                'Road Accident Type': ['Overspeeding', 'Distracted Driving', 'Drunk Driving', 'Reckless Driving', 'Fatigue', 'Inexperience', 'Mechanical Failure', 'Poor Maintenance', 'Overloading'],
                'Weather Conditions': ['Sunny', 'Rainy', 'Foggy', 'Cloudy', 'Stormy'],
                'Road Conditions': ['Dry', 'Wet', 'Icy', 'Potholes', 'Gravel'],
                'Vehicle Types': ['Car and Motorcycle', 'Car and Bus', 'Car and Truck', 'Car and Bicycle', 'Motorcycle and Car', 'Motorcycle and Bus', 'Motorcycle and Truck', 'Motorcycle and Bicycle', 'Truck and Car', 'Truck and Motorcycle', 'Truck and Bus', 'Truck and Bicycle', 'Bus and Car', 'Bus and Motorcycle', 'Bus and Truck', 'Bus and Bicycle', 'Bicycle and Car', 'Bicycle and Motorcycle', 'Bicycle and Bus', 'Bicycle and Truck'],
                'Driver Ages': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+'],
                'Driver Gender': ['Male', 'Female']
            },
            'Fire Incident': {
                'Fire Cause': [
                    'Electrical ignition caused by loose connection', 'Electrical ignition caused by overloading', 'Electrical ignition due to pinched wire',
                    'Electrical ignition caused by arcing', 'Overheated industrial machinery', 'Sparks from machinery', 'Overheated home appliances', 'Electrical post fire to structural fire',
                    'Transformer pole fire to structural fire', 'Open flame from cooking (LPG / gas stove, firewood)', 'Open flame from unattended lighted candle',
                    'Open flame from kerosene lamp (gasera) / lighting torch (sulo)', 'Open flame from rubbish fire / bonfire to structural fire',
                    'Open flame from farmland / agricultural land clearing operation', 'Open flame from kaingin (slash and burn)',
                    'Ignition caused by firecracker explosion', 'Ignition caused by fireworks / pyrotechnics explosion', 'Ignition caused by bomb explosion',
                    'Spontaneous combustion of chemicals', 'Spontaneous combustion of solid materials',
                    'Intentional fire by use of incendiary device or mechanism', 'Intentional fire by use of flammable liquid',
                    'Intentional fire by use of open flame (matchstick or lighter or light torch)', 'Ignition of material caused by welding slags',
                    'Ignition of materials caused by acetylene / other hot works', 'LPG explosion caused by defective tank',
                    'LPG explosion caused by defective hose line', 'LPG explosion caused by defective regulator',
                    'LPG explosion caused by defective stove', 'LPG explosion caused by static electricity or spark',
                    'Fire caused by lightning', 'Ignition of materials from ember / flying ember or alipato',
                    'Smoking (lighted cigarette, cigar or pipe)', 'Children playing matchstick or lighter',
                    'Battery short circuit or battery explosion', 'Dust explosion', 'Magnified / amplified sun rays',
                    'Overheated engine (motor vehicles)', 'Sky lantern', 'Fire incident under investigation (on process)',
                    'Undetermined fire cause (on pending investigation)'
                ],
                'Occupancy Type': [
                    'Assembly', 'Educational', 'Day-Care', 'Health Care',
                    'Detention & Correctional / Institutional', 'Residential',
                    'Mercantile', 'Business', 'Industrial', 'Storage',
                    'Mixed Occupancies', 'Miscellaneous Occupancies'
                ],
                'Class': {
                    'CLASS A': 'Ordinary Combustibles\n(Wood, paper, cloth, plastic, rubber, trash, and other common combustible materials. Extinguishing Method: Water, foam, dry chemical.)',
                    'CLASS B': 'Flammable Liquids & Gases\n(Gasoline, diesel, alcohol, paints, solvents, kerosene, LPG, acetylene, etc. Extinguishing Method: Foam, dry chemical (ABC/BC), CO2. Do NOT use water - it spreads the flammable liquid.)',
                    'CLASS C': 'Energized Electrical Equipment\n(Electrical panels, wirings, appliances, transformers, computers, breakers. Extinguishing Method: Dry chemical, CO2.)',
                    'CLASS D': 'Combustible Metals\n(Magnesium, titanium, sodium, potassium, zirconium, lithium. Extinguishing Method: Special Class D dry powder extinguishers. Do NOT use water - it reacts violently.)',
                    'CLASS K (or Class F)': 'Cooking Oils & Fats\n(Hot oils and fats from deep fryers, lard, shortening, grease.)'
                }
            },
            'Crime Incident': {
                'Crime Types': ['Theft', 'Assault', 'Burglary', 'Robbery', 'Vandalism', 'Harassment', 'Domestic Violence', 'Drug-Related', 'Fraud'],
                'Crime Causes': ['Poverty', 'Unemployment', 'Alcohol', 'Drugs', 'Personal Dispute', 'Gang Activity', 'Opportunistic', 'Domestic Issue', 'Mental Health'],
                'Levels': ['Low', 'Medium', 'High'],
                'Suspect Gender': ['Male', 'Female'],
                'Victim Gender': ['Male', 'Female'],
                'Suspect Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+'],
                'Victim Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+']
            },
            'Health Emergency': {
                'Health Emergency Types': ['Heart Attack', 'Stroke', 'Fall', 'Breathing Difficulty', 'Giving Birth', 'Seizure', 'Burn', 'Poisoning', 'Allergic Reaction'],
                'Health Causes': ['Pregnant', 'Chronic Illness', 'Accident', 'Allergy', 'Infection', 'Overdose', 'Heatstroke'],
                'Patient Gender': ['Male', 'Female'],
                'Patient Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+']
            }
        };

        // Track alerts
        const liveAlerts = new Map();   // alert_id ‚Üí { element, timestamp }
        const recentAlerts = new Map();
        const alertElements = new Map(); // for response updates

        let yearlyChart = null;
        let monthlyChart = null;

        function initializeCharts() {
            // Yearly Forecast
            yearlyChart = new Chart(document.getElementById('yearlyPredictionChart'), {
                type: 'line',
                data: {
                    labels: ['2020', '2021', '2022', '2023 (Predicted)'],
                    datasets: [{
                        label: 'Road Accidents',
                        data: [45, 68, 92, 92],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231,76,60,0.2)',
                        borderWidth: 7,
                        pointRadius: 12,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 1800 } }
            });

            // Monthly Forecast (2022 vs 2023)
            monthlyChart = new Chart(document.getElementById('monthlyPredictionChart'), {
                type: 'line',
                data: {
                    labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                    datasets: [
                        { label: '2022', data: [28,32,35,30,40,38,42,45,41,36,33,30], borderColor: '#3498db', fill: false },
                        { label: '2023 Forecast', data: [30,30,30,30,30,30,30,30,30,30,30,30], borderColor: '#e74c3c', fill: false, borderWidth: 5 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        socket.on('update_prediction_charts', (data) => {
                updateCharts(data.prediction);
            });

            // Initial load
            fetch('/get_latest_prediction')
                .then(r => r.json())
                .then(res => updateCharts(res.prediction));

        function updateCharts(predictionText) {
            if (!predictionText.includes('%')) return;
            const prob = parseFloat(predictionText.match(/(\d+\.\d+)%/)[1]);
            const yearlyCount = Math.round((prob / 100) * 150);
            const monthlyCount = Math.round(yearlyCount / 12);

            // Update yearly chart
            yearlyChart.data.datasets[0].data[3] = yearlyCount;
            yearlyChart.options.plugins = { title: { display: true, text: `2023 Forecast: ${prob.toFixed(1)}% Risk` } };
            yearlyChart.update();

            // Update monthly chart ‚Äî 2023 line overlaps more when risk is high
            const base2022 = [28,32,35,30,40,38,42,45,41,36,33,30];
            const monthly2023 = base2022.map(val => val + (monthlyCount - 30));
            monthlyChart.data.datasets[1].data = monthly2023;
            monthlyChart.update();
        }

        // Move alert from Live ‚Üí Recent after 60 seconds
        function moveToRecent(alertId) {
            if (!liveAlerts.has(alertId)) return;
            const { element } = liveAlerts.get(alertId);
            liveAlerts.delete(alertId);
            recentAlerts.set(alertId, { element, timestamp: Date.now() });
            
            element.querySelector('div:first-child').textContent = 'EXPIRED ALERT';
            document.getElementById('recent-alert-container')
                    .insertBefore(element, document.getElementById('recent-alert-container').firstChild);
        }

        // Tab switching
        document.querySelectorAll('.alert-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.alert-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-alerts-tab').classList.add('active');
            });
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('shifted');
        }

        

        document.addEventListener('DOMContentLoaded', () => {
            const lat = {{ lat_coord|default(14.0549) }};
            const lon = {{ lon_coord|default(121.3013) }};
            const mapboxToken = 'pk.eyJ1Ijoia3VtaXRva2lydSIsImEiOiJjbWNvZXpkdDQwNmdvMnNyMnNtNGw5NGI1In0.3Y9z5y4saOL76Eb5c-o0UQ';
            const tileLayerUrl = `https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxToken}`;

            const barangayMap = L.map('map').setView([lat, lon], 16);

            var satellite = L.tileLayer(tileLayerUrl, {
                attribution: 'Map data ¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery ¬© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                tileSize: 512,
                zoomOffset: -1
            });

            var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            });

            satellite.addTo(barangayMap);

            var baseLayers = {
                "Satellite with Labels": satellite,
                "OpenStreetMap": osm
            };
            L.control.layers(baseLayers).addTo(barangayMap);

            const socket = io('https://alertnow-wi0n.onrender.com', { transports: ['websocket'] });


            

            // Chart
            const ctx = document.getElementById('emergencyTypeChart').getContext('2d');
            let emergencyTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Road Accident', 'Crime Incident', 'Fire Incident', 'Health Emergency'],
                    datasets: [{
                        label: 'Emergency Types',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                        borderColor: ['#000000ff', '#000000ff', '#000000ff', '#000000ff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#000000', font: { size: 17 } }
                        }
                    }
                }
            });

            fetch('/barangay_emergency_types')
                .then(r => r.json())
                .then(data => {
                    emergencyTypeChart.data.datasets[0].data = [
                        data['Road Accident'] || 0,
                        data['Crime Incident'] || 0,
                        data['Fire Incident'] || 0,
                        data['Health Emergency'] || 0
                    ];
                    emergencyTypeChart.update();
                });

            socket.on('update_emergency_types', (data) => {
                emergencyTypeChart.data.datasets[0].data = [
                    data['Road Accident'] || 0,
                    data['Crime Incident'] || 0,
                    data['Fire Incident'] || 0,
                    data['Health Emergency'] || 0
                ];
                emergencyTypeChart.update();
            });

            // Initialize Yearly Prediction Chart
            const yearlyCtx = document.getElementById('yearlyPredictionChart').getContext('2d');
            yearlyPredictionChart = new Chart(yearlyCtx, {
                type: 'line',
                data: {
                    labels: ['2020', '2021', '2022', '2023 (Predicted)'],
                    datasets: [{
                        label: 'Road Accidents Per Year',
                        data: [0, 0, 392, 92],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderWidth: 4,
                        pointBackgroundColor: ['#3498db', '#3498db', '#3498db', '#e74c3c'],
                        pointRadius: [6, 6, 6, 10],
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 450 },
                        x: { title: { display: true, text: 'Year' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Yearly Road Accident Trend & Forecast', font: { size: 16 } },
                        legend: { display: false }
                    }
                }
            });

            // Initialize Monthly Prediction Chart
            const monthlyCtx = document.getElementById('monthlyPredictionChart').getContext('2d');
            monthlyPredictionChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', '2023 Avg (Pred.)'],
                    datasets: [{
                        label: '2022 Accidents',
                        data: [30, 25, 40, 35, 45, 50, 55, 60, 50, 45, 40, 38, null], // Sample 2022 data
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 4,
                    }, {
                        label: '2023 Accidents (Predicted)',
                        data: [null, null, null, null, null, null, null, null, null, null, null, null, 55], // Placeholder for prediction
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderWidth: 4,
                        pointBackgroundColor: '#e74c3c',
                        pointRadius: 10,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 80 },
                        x: { title: { display: true, text: 'Months (2022-2023)' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Monthly Road Accident Trend & Forecast', font: { size: 16 } },
                        legend: { position: 'top' }
                    }
                }
            });

            function updatePredictionCharts(predictionText) {
                if (predictionText && predictionText.includes('%')) {
                    const match = predictionText.match(/(\d+\.\d+)%/);
                    const probability = match ? parseFloat(match[1]) : 50;

                    // Update Yearly Chart
                    const yearlyPredictedCount = Math.round((probability / 100) * 400); // Assuming max is around 400
                    yearlyPredictionChart.data.datasets[0].data[3] = yearlyPredictedCount;
                    yearlyPredictionChart.options.plugins.title.text = `Yearly Forecast (${probability.toFixed(1)}% Risk)`;
                    yearlyPredictionChart.update();

                    // Update Monthly Chart
                    const monthlyPredictedCount = Math.round((probability / 100) * 70); // Assuming monthly max is around 70
                    monthlyPredictionChart.data.datasets[1].data[12] = monthlyPredictedCount;
                    monthlyPredictionChart.options.plugins.title.text = `Monthly Forecast (${probability.toFixed(1)}% Risk)`;
                    monthlyPredictionChart.update();
                }
            }

            // Initial fetch for prediction data
            fetch('/get_latest_prediction')
                .then(r => r.json())
                .then(res => {
                    updatePredictionCharts(res.prediction);
                })
                .catch(err => console.error("Prediction fetch failed:", err));


            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('register_role', { role: 'barangay', barangay: '{{ barangay }}'.toLowerCase() });
            });

            // MAIN: Handle incoming alerts
            socket.on('new_alert', (data) => {
                console.log('New alert received:', data);
                updateUIWithAlert(data);
                notifyAlert(data);
            });

            socket.on('redirected_alert', (data) => {
                if (data.target_role === 'barangay') {
                    updateUIWithAlert(data);
                    notifyAlert(data);
                }
            });

            socket.on('update_dashboard_emergency_type', (data) => {
                console.log('Emergency type update received:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (!alertItem) return;

                const typeDiv = alertItem.querySelector('div:nth-child(3)');
                typeDiv.textContent = `Type: ${data.emergency_type || 'N/A'}`;
                typeDiv.style.display = 'block';

                const responseForm = alertItem.querySelector('.response-form');
                responseForm.innerHTML = ''; // Clear previous dropdowns
                responseForm.style.display = 'block';

                const emergencyType = data.emergency_type || 'Road Accident';
                const dropdownData = menuData[emergencyType] || menuData['Road Accident'];

                // Build dropdowns from menuData
                Object.keys(dropdownData).forEach(key => {
                    const select = document.createElement('select');
                    select.className = 'dropdown-emergency';
                    select.name = key.toLowerCase().replace(/\s+/g, '_');

                    const placeholder = document.createElement('option');
                    placeholder.text = `Select ${key}`;
                    placeholder.value = '';
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    select.appendChild(placeholder);

                    let options = dropdownData[key];

                    // Handle nested Class object
                    if (typeof options === 'object' && !Array.isArray(options)) {
                        options = Object.keys(options);
                    }

                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = typeof opt === 'string' && opt.includes('\n') 
                            ? opt.split('\n')[0] 
                            : opt;
                        select.appendChild(option);
                    });

                    responseForm.appendChild(select);
                });

                // Submit button
                const submitButton = document.createElement('button');
                submitButton.textContent = 'Respond';
                submitButton.className = 'submit-emergency';
                submitButton.addEventListener('click', () => {
                    const formData = {
                        alert_id: data.alert_id,
                        emergency_type: emergencyType,
                        barangay: '{{ barangay }}'
                    };

                    responseForm.querySelectorAll('select').forEach(select => {
                        formData[select.name] = select.value;
                    });

                    // Choose correct emit event
                    const eventMap = {
                        'Road Accident': 'barangay_response',
                        'Fire Incident': 'barangay_fire_submitted',
                        'Crime Incident': 'barangay_crime_submitted',
                        'Health Emergency': 'barangay_health_response'
                    };

                    const socketEvent = eventMap[emergencyType] || 'barangay_response';
                    socket.emit(socketEvent, formData);

                    responseForm.style.display = 'none';
                    const statusDiv = alertItem.querySelector('div:first-child');
                    statusDiv.textContent = 'RESPONDED';
                    statusDiv.style.color = '#27ae60';
                });

                responseForm.appendChild(submitButton);
            });

            socket.on('hospital_alert_barangay', (data) => {
                console.log('Hospital admission notification received:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const admissionDiv = document.createElement('div');
                    admissionDiv.textContent = `\nAdmit to ${data.hospital_name}`;
                    admissionDiv.style.fontSize = '16px';
                    admissionDiv.style.fontWeight = 'bold';
                    admissionDiv.style.color = 'black';
                    alertItem.appendChild(admissionDiv);
                }
            });

            // === ROAD ACCIDENT RESPONSE (Same Style as Fire) ===
            // Update prediction display after submission
            socket.on('barangay_response', (data) => {
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    predictionDiv.textContent = `Prediction: ${data.prediction || 'N/A'}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.color = 'black';
                    predictionDiv.style.fontSize = '18px';

                    // UPDATE PREDICTION CHARTS WITH NEW FORECAST
                    updatePredictionCharts(data.prediction);
                }
            });

            socket.on('barangay_fire_submitted', (data) => {
                console.log('Fire response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '18px';
                    predictionDiv.style.color = 'black';
                }
            });

            socket.on('barangay_crime_submitted', (data) => {
                console.log('Crime response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '18px';
                    predictionDiv.style.color = 'black';
                }
            });
            socket.on('barangay_health_response', (data) => {
                console.log('Crime response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '18px';
                    predictionDiv.style.color = 'black';
                }
            });

            socket.on('update_map', (data) => {
                console.log('Update map received:', data);
                const lat = data.lat || {{ lat_coord|default(14.0549) }};
                const lon = data.lon || {{ lon_coord|default(121.3013) }};
                barangayMap.setView([lat, lon], 16);
                L.marker([lat, lon]).addTo(barangayMap).bindPopup(
                    `Emergency at ${data.barangay} Resident from ${data.resident_barangay || data.barangay}`
                ).openPopup();
                document.getElementById('map-coordinates').textContent = `${lat}, ${lon}`;
            });

            function updateUIWithAlert(data) {
                const isLive = data.expired !== true;
                const container = isLive 
                    ? document.getElementById('live-alert-container')
                    : document.getElementById('recent-alert-container');

                const alertItem = document.createElement('div');
                alertItem.className = 'alert-item';
                alertItem.innerHTML = `
                    <div>${isLive ? 'PENDING ALERT' : 'RESPONDED'}</div>
                    <div>Emergency at ${data.barangay} Resident from ${data.resident_barangay || data.barangay}</div>
                    <div style="display: none;">Type: ${data.emergency_type || 'N/A'}</div>
                    <div>Time: ${new Date().toLocaleTimeString()}</div>
                    ${data.image ? `<img src="data:image/jpeg;base64,${data.image}" class="clickable-img" />` : ''}
                    <div class="response-form"></div>
                    <div class="prediction" style="display: none;">Prediction: N/A</div>
                `;

                if (data.image) {
                    alertItem.querySelector('img').addEventListener('click', () => {
                        document.getElementById('modal-image').src = `data:image/jpeg;base64,${data.image}`;
                        document.getElementById('image-modal').style.display = 'flex';
                    });
                }

                const acceptButton = document.createElement('button');
                acceptButton.textContent = 'Accept';
                acceptButton.className = 'submit-emergency';

                const declineButton = document.createElement('button');
                declineButton.textContent = 'Decline';
                declineButton.className = 'submit-emergency';

                const roleButtonsContainer = document.createElement('div');
                roleButtonsContainer.className = 'response-form';
                roleButtonsContainer.style.display = 'none';

                const pnpEmergencyTypeContainer = document.createElement('div');
                pnpEmergencyTypeContainer.className = 'response-form';
                pnpEmergencyTypeContainer.style.display = 'none';

                // === ALL YOUR ORIGINAL ROLE + PNP BUTTON LOGIC (unchanged) ===
                
                const roles = ['CDRRMO & PNP', 'BFP & PNP', 'Health', 'PNP'];
                roles.forEach(role => {
                    const roleButton = document.createElement('button');
                    if (role === 'CDRRMO & PNP') roleButton.textContent = 'Send to CDRRMO & PNP';
                    else if (role === 'BFP & PNP') roleButton.textContent = 'Send to BFP & PNP';
                    else if (role === 'Health') roleButton.textContent = 'Send to Health';
                    else roleButton.textContent = 'Send to PNP (Crime Incident)';
                    roleButton.className = 'submit-emergency';

                    roleButton.addEventListener('click', () => {
                        let emergencyType = '';
                        let targetRoles = [];

                        if (role === 'CDRRMO & PNP') {
                            emergencyType = 'Road Accident';
                            targetRoles = ['cdrrmo', 'pnp'];
                        } else if (role === 'BFP & PNP') {
                            emergencyType = 'Fire Incident';
                            targetRoles = ['bfp', 'pnp'];
                        } else if (role === 'Health') {
                            emergencyType = 'Health Emergency';
                            targetRoles = ['health'];
                        } else if (role === 'PNP') {
                            emergencyType = 'Crime Incident';
                            targetRoles = ['pnp'];
                        }

                        // SEND TO ALL TARGETS
                        targetRoles.forEach(tr => {
                            const redirectData = {
                                alert_id: data.alert_id,
                                target_role: tr,
                                emergency_type: emergencyType,
                                municipality: 'San Pablo City',
                                barangay: '{{ barangay }}',
                                lat: data.lat,
                                lon: data.lon,
                                image: data.image
                            };

                            if (tr === 'pnp') {
                                socket.emit('pnp_redirect_alert', redirectData);
                            } else {
                                socket.emit('redirect_alert', redirectData);
                            }
                        });

                        // TRIGGER DROPDOWNS ON BARANGAY DASHBOARD
                        socket.emit('update_dashboard_emergency_type', {
                            alert_id: data.alert_id,
                            emergency_type: emergencyType,
                            barangay: '{{ barangay }}'.toLowerCase(),
                            municipality: 'San Pablo City'
                        });

                        roleButtonsContainer.style.display = 'none';
                        const typeDiv = alertItem.querySelector('div:nth-child(3)');
                        typeDiv.textContent = `Type: ${emergencyType}`;
                        typeDiv.style.display = 'block';
                    });

                    roleButtonsContainer.appendChild(roleButton);
                });

                

                acceptButton.addEventListener('click', () => {
                    socket.emit('role_accepted', { alert_id: data.alert_id, role: 'barangay' });
                    roleButtonsContainer.style.display = 'block';
                    acceptButton.style.display = 'none';
                    declineButton.style.display = 'none';

                    // ONLY ACCEPTED ALERTS GET TIMER
                    liveAlerts.set(data.alert_id, { element: alertItem });
                    setTimeout(() => moveToRecent(data.alert_id), 60000);
                });

                declineButton.addEventListener('click', () => {
                    socket.emit('role_declined', { alert_id: data.alert_id, role: 'barangay' });
                    liveAlerts.delete(data.alert_id);
                    recentAlerts.delete(data.alert_id);
                    alertElements.delete(data.alert_id);
                    alertItem.remove();
                });

                alertItem.appendChild(acceptButton);
                alertItem.appendChild(declineButton);
                alertItem.appendChild(roleButtonsContainer);
                alertItem.appendChild(pnpEmergencyTypeContainer);
                alertElements.set(data.alert_id, alertItem);

                container.appendChild(alertItem); // Use appendChild for horizontal flow

                // Close modal
                document.querySelector('.close-btn').onclick = () => {
                    document.getElementById('image-modal').style.display = 'none';
                };
            }

            function parseMenuText(text) {
                const sections = text.split('#').filter(section => section.trim());
                const menuData = {};
                sections.forEach(section => {
                    const lines = section.trim().split('\n');
                    const sectionName = lines[0].trim();
                    const sectionData = {};
                    lines.slice(1).forEach(line => {
                        const [key, values] = line.split(':');
                        sectionData[key.trim()] = values.split(',').map(v => v.trim());
                    });
                    menuData[sectionName] = sectionData;
                });
                return menuData;
            }

            document.getElementById('recent-date-filter').addEventListener('change', (e) => {
                const selected = e.target.value;
                document.querySelectorAll('#recent-alert-container .alert-item').forEach(item => {
                    const timeText = item.querySelector('div:nth-child(4)').textContent;
                    const date = new Date().toISOString().slice(0,10);
                    item.style.display = (!selected || date === selected) ? 'block' : 'none';
                });
            });

            function notifyAlert(data) {
                const n = document.getElementById('notification');
                n.textContent = `New Alert: ${data.emergency_type || 'Unknown'} at ${data.barangay}`;
                setTimeout(() => n.textContent = '', 5000);
            }

            socket.on('bfp_responding', (data) => {
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    // Show "BFP IS ON THE WAY" message
                    const msg = document.createElement('div');
                    msg.textContent = 'BFP IS ON THE WAY';
                    msg.style.cssText = 'background:#e74c3c;color:white;padding:10px;border-radius:8px;text-align:center;font-weight:bold;margin:10px 0;';
                    alertItem.appendChild(msg);
                    setTimeout(() => msg.remove(), 5000);

                    // Add RED BFP marker on map
                    if (data.bfp_lat && data.bfp_lon) {
                        const bfpMarker = L.marker([data.bfp_lat, data.bfp_lon], {
                            icon: L.divIcon({
                                html: '<div style="background:red;width:30px;height:30px;border-radius:50%;border:4px solid white;animation:pulse 2s infinite;"></div>',
                                className: 'bfp-marker',
                                iconSize: [38, 38],
                                iconAnchor: [19, 19]
                            })
                        }).addTo(barangayMap)
                        .bindPopup('<b>BFP RESPONDING</b><br>Fire Truck En Route')
                        .openPopup();

                        window.activeMarkers[`bfp_${data.alert_id}`] = bfpMarker;
                    }
                }
            });

            function determineEmergencyType(role) {
                switch (role.toLowerCase()) {
                    case 'cdrrmo': return 'Road Accident';
                    case 'bfp': return 'Fire Incident';
                    case 'city health': return 'Health Emergency';
                    default: return 'Unknown';
                }
            }
        });
    </script>
</body>
</html>
